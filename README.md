# Интеллектуальные системы лабораторная 2 Классификация семей по уровню дохода с использованием экспертной системы и LLM


**Студент: Нестеренко Даниил**
**Группа: 932302**

---
## 🔍 **Цель работы**

Разработка гибридной системы классификации семей по уровню дохода на основе:

1. **Экспертных правил** (набор логических условий и порогов, зависящих от города).
2. **Языковой модели LLM** (Mistral-7B-Instruct-v0.2), взаимодействующей через LangChain.

## ⚙️ **Описание архитектуры решения**


### 🔹 **1. Классическая экспертная система (`main2.py`)**

![Pasted image 20250531024126](https://github.com/user-attachments/assets/02f87c9b-a155-47a4-bf6f-72d70e310d46)


- Использует загруженные пороговые значения по городам и логические правила из `classification_rules.json`.
    
- Классификация проводится через логическое сопоставление условий (`>` / `<` / `==` и т.д.) между параметрами семьи и рассчитанными значениями выражений вида `1.8 * Median`.
    
- Ключевые методы:
    
    - `_evaluate_expression(expr, thresholds)`: вычисление выражения на основе городских порогов.
    - `_evaluate_condition(...)`: проверка одного условия.
    - `_check_rule_set(...)`: проверка набора условий (AND-связка).
    - `classify_family(...)`: основная функция классификации.

### 🔹 **2. Нейросетевая система на основе LLM (`main3.py`)**

![Pasted image 20250531023700](https://github.com/user-attachments/assets/0ea7b58b-bd09-4ae3-8f08-c2067b281ad8)


- Загружает **Mistral-7B-Instruct-v0.2** с квантованием в 4 бита (при наличии CUDA).
    
- Использует **LangChain + HuggingFacePipeline** для общения с моделью.
    
- Генерирует **system prompt**, включающий:
    
    - Пороговые значения по городу (`city_thresholds.json`)
        
    - Формализованные правила классификации (`classification_rules.json`)
        
    - Вводные данные по семье
        
- Отправляет промпт в LLM и извлекает текстовую классификацию.

---

## 📁 **Файлы проекта**

|Имя файла|Назначение|
|---|---|
|`main2.py`|Классическая система классификации|
|`main3.py`|Система классификации через LLM|
|`tests3.py`|Модуль для автоматического тестирования и сравнения|
|`classification_rules.json`|Набор экспертных правил|
|`city_thresholds.json`|Пороговые данные по 56898 городам|

---

## 🧪 **Тестирование (`tests3.py`)**

![Pasted image 20250531024217](https://github.com/user-attachments/assets/029e7be9-10fe-4444-bd81-64bd390d1268)


- Проведено сравнение результатов между экспертной системой и LLM.
    
- Пример входных данных для теста:

`{   "City": "New York",   "Median": 200000,   "Mean": 220000,   "ALand": 3000,   "AWater": 100,   "Stdev": 0.4 }`

- Пример логики для извлечения ответа из LLM:

`first_line = text.strip().split('\n')[0] category = first_line.split()[0]`

- Общее количество тестов: 10
    
- Каждая запись включает:
    - Ожидаемую категорию
    - Категорию от экспертной системы
    - Категорию и полный ответ от LLM


---

## 📈 **Результаты тестирования**

| №   | Ожидание           | Классическая       | Нейросеть          | Совпадение |
| --- | ------------------ | ------------------ | ------------------ | ---------- |
| 1   | Обеспеченная       | Wealthy            | Wealthy            | ✅          |
| 2   | Средний класс      | Middle class       | Middle class       | ✅          |
| 3   | Бедная             | Poor               | Poor               | ✅          |
| 4   | За гранью бедности | Below poverty line | Below poverty line | ✅          |
| 5   | Обеспеченная       | Wealthy            | Wealthy            | ✅          |
| 6   | Средний класс      | Middle class       | Middle class       | ✅          |
| 7   | Бедная             | Poor               | Poor               | ✅          |
| 8   | За гранью бедности | Below poverty line | Below poverty line | ✅          |
| 9   | Обеспеченная       | Wealthy            | Wealthy            | ✅          |
| 10  | Средний класс      | Middle class       | Middle class       | ✅          |

✅ Обе системы дали **одинаковый результат во всех тестах**.

---

## 🧠 **Особенности использования LLM**

- Языковая модель интерпретирует логические правила, заданные в текстовом виде.
    
- Используется системный промпт с пояснениями: что такое "City Median", как трактовать выражения.
    
- ==Важно: выражения вида `1.8 * Median` внутри правил интерпретируются с учётом **городских порогов**, а данные семьи имеют префикс `Family`.==

---

## ✅ **Выводы**

- **Комбинация экспертных правил и LLM** обеспечивает гибкую и интерпретируемую систему.
    
- **Классическая система** быстрее и детерминированна, подходит для embedded решений.
    
- **LLM-система** лучше масштабируется и справляется с «размытой» логикой и нестандартными случаями.
    
- В данной реализации обе системы демонстрируют **идентичную точность** на тестовом наборе.
    

---
